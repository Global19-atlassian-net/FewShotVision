
---
version: 1

kind: group

environment:
  resources:
    gpu:
      requests: 1
      limits: 1

hptuning:

  concurrency: 2

  matrix:
    dataset:
      values: [CUB]
    method:
      values: [protonet]
    n_shot:
      values: [5]
    train_n_way:
      values: [5, 10]
    test_n_way:
      values: [5]

build:
  image: sicara/leto-stack:tf1.13.0rc0-gpu-pipeline0.7.1-chani0.0.8
  build_steps:
    - pip install --no-cache-dir -r requirements.txt
  env_vars:
    - ['LC_ALL', 'C.UTF-8']
    - ['PYTHONPATH', '$PYTHONPATH:/code']

run:
  cmd:
    # Allow to access the mounted data_folder as if it was in ./data
    - ln -s /data/etienneb ./data
    # Allow to access the mounted output_folder as if it was in ./output
    - ln -s $POLYAXON_RUN_OUTPUTS_PATH ./output
    # Create grid
    - touch grid_search_parameters.yaml
    - 'echo "method: {{ method }}" >> grid_search_parameters.yaml'
    - 'echo "n_shot: {{ n_shot }}" >> grid_search_parameters.yaml'
    - 'echo "dataset: {{ dataset }}" >> grid_search_parameters.yaml'
    - 'echo "train_n_way: {{ train_n_way }}" >> grid_search_parameters.yaml'
    - 'echo "test_n_way: {{ test_n_way }}" >> grid_search_parameters.yaml'
    # Run the pipeline defined in the pipelines folder
    - run-pipeline pipelines/run_experiment_grid.yaml -v grid_search_parameters.yaml
